<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Team Manager ‚Äî Invodes</title>
<link rel="icon" href="data:," />
<style>
:root{
  --bg:#f4f7fb; --card:#fff; --muted:#2e3b43; --accent:#2563eb; --accent2:#06b6d4;
  --dark-bg:#0b1220; --dark-card:#0f1724; --dark-muted:#cfd8e3;
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Roboto,Arial}
body{margin:0;background:var(--bg);color:var(--muted)}
.app{max-width:460px;margin:0 auto;padding:18px;padding-bottom:110px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06);margin-bottom:12px}
.small{font-size:13px;color:#55616a}
input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(48,64,79,0.08);margin-bottom:10px}
button{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:10px;border-radius:10px;color:#fff;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(48,64,79,0.08);color:var(--muted)}
.nav-bottom{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center}
.nav-inner{max-width:460px;width:100%;padding:10px;background:var(--card);border-radius:999px;box-shadow:0 10px 30px rgba(16,24,40,0.08);display:flex;gap:6px;justify-content:space-around}
.nav-btn{flex:1;padding:8px;border-radius:10px;background:transparent;border:none;color:var(--muted);display:flex;flex-direction:column;align-items:center;font-size:12px}
.nav-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.hidden{display:none!important}
.toast{position:fixed;left:12px;right:12px;bottom:84px;z-index:9999;display:none}
.small-muted{font-size:12px;color:#778992}
.list{max-height:40vh;overflow:auto}
.skeleton{background:linear-gradient(90deg,#eee,#f7f7f7,#eee);height:14px;border-radius:6px;margin-bottom:8px}
.searchBar{display:flex;gap:8px;margin-bottom:10px}
.dark{background:var(--dark-bg);color:var(--dark-muted)}
.dark .card{background:var(--dark-card);box-shadow:none}
.confirm{padding:12px;background:#fff;border-radius:10px;border:1px solid rgba(0,0,0,0.06)}
.heatmap{display:flex;flex-wrap:wrap;gap:4px}
.heatday{width:18px;height:18px;border-radius:3px;background:#e6eef8}
.heat-1{background:#d0f2c4}
.heat-2{background:#93d985}
.heat-3{background:#47b03a}
.heat-4{background:#236b1e;color:#fff}
.switch{display:inline-flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="app" id="appRoot">

  <div class="header">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">TM</div>
      <div>
        <div style="font-weight:700">Team Manager</div>
        <div class="small small-muted" id="subTitle">Invodes</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button onclick="toggleDark()" id="darkBtn">üåô</button>
      <button id="authBtn" onclick="openAuth()">Login</button>
    </div>
  </div>

  <div id="homePanel" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Welcome</strong><div class="small">Submit daily logs. Admins manage attendance, tasks & broadcasts.</div></div>
      <div class="small" id="todayLabel"></div>
    </div>
    <div class="searchBar" style="margin-top:10px">
      <input id="searchInput" placeholder="Search users, logs, tasks..." oninput="onSearch()" />
      <button class="ghost" onclick="onSearchClear()">Clear</button>
    </div>
    <div id="homeMini" style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1"><button onclick="navTo('log')">Write Log</button></div>
      <div style="flex:1"><button class="ghost" onclick="navTo('tasks')">Tasks</button></div>
    </div>
  </div>

  <!-- AUTH PANEL -->
  <div id="authPanel" class="card hidden">
    <div id="loginView">
      <strong>Login</strong>
      <input id="loginMobile" placeholder="mobile or admin" />
      <input id="loginPassword" type="password" placeholder="password" />
      <div style="display:flex;gap:8px">
        <button id="loginBtn" onclick="doLogin()">Login</button>
        <button class="ghost" onclick="showRegister()">Register</button>
      </div>
      <div style="margin-top:8px"><a href="#" onclick="showResetRequest();return false" class="small-muted">Forgot password / OTP</a></div>
      <div id="loginMsg" class="small" style="margin-top:6px;color:#b00020"></div>
    </div>

    <div id="registerView" class="hidden">
      <strong>Register</strong>
      <input id="regMobile" placeholder="mobile" />
      <input id="regPassword" placeholder="password" />
      <div style="display:flex;gap:8px">
        <button onclick="doRegister()">Register</button>
        <button class="ghost" onclick="showLogin()">Back</button>
      </div>
      <div id="regMsg" class="small" style="margin-top:6px;color:#b00020"></div>
    </div>

    <div id="resetReqView" class="hidden">
      <strong>Reset/OTP request</strong>
      <input id="resetMobile" placeholder="registered mobile" />
      <div style="display:flex;gap:8px">
        <button onclick="doRequestReset()">Request code</button>
        <button class="ghost" onclick="showLogin()">Back</button>
      </div>
      <div id="resetReqMsg" class="small" style="margin-top:6px;color:#b00020"></div>
    </div>

    <div id="resetConfirmView" class="hidden">
      <strong>Enter code</strong>
      <input id="resetConfirmMobile" />
      <input id="resetCode" />
      <input id="resetNewPw" type="password" />
      <div style="display:flex;gap:8px">
        <button onclick="doConfirmReset()">Set password</button>
        <button class="ghost" onclick="showLogin()">Cancel</button>
      </div>
      <div id="resetConfirmMsg" class="small" style="margin-top:6px;color:#b00020"></div>
    </div>
  </div>

  <!-- MEMBER PANEL -->
  <div id="memberPanel" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Your Daily Log</strong>
      <div>
        <div class="small" id="memberToday"></div>
        <div class="small" id="memberStatus"></div>
      </div>
    </div>
    <textarea id="logContent" placeholder="Describe today's work..." rows="5"></textarea>
    <div style="display:flex;gap:8px">
      <button onclick="confirmAction('Submit log?', submitLog)">Submit / Edit</button>
      <button class="ghost" onclick="getMyLogs()">My logs</button>
    </div>
    <div id="myLogs" class="list"></div>
  </div>

  <!-- TASKS -->
  <div id="tasksPanel" class="card hidden">
    <div style="display:flex;justify-content:space-between">
      <strong>Tasks</strong>
      <div class="small"><button onclick="loadTasks()">Refresh</button></div>
    </div>
    <div id="tasksList" class="list"></div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="card hidden">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="loadPending()">Pending</button>
      <button onclick="loadUsers()">Users</button>
      <button onclick="loadAttendance()">Attendance</button>
      <button onclick="loadDashboard()">Summary</button>
      <button onclick="openAdminTools()">Tools</button>
      <button onclick="openAnalytics()">Analytics</button>
    </div>
    <div id="adminMain" style="margin-top:12px"></div>
  </div>

  <div id="panelList" class="card hidden"><div id="panelListInner"></div></div>

  <div id="adminToolsPanel" class="card hidden">
    <strong>Admin Tools</strong>
    <div style="margin-top:8px">
      <label>Export month (yyyy-mm)</label><input id="exportMonth" placeholder="2025-12" />
      <div style="display:flex;gap:8px"><button onclick="exportMonth()">Export PDF</button><button class="ghost" onclick="openAdmin()">Back</button></div>
      <hr/>
      <label>Broadcast message</label><textarea id="broadcastMsg" rows="3"></textarea>
      <div style="display:flex;gap:8px"><button onclick="confirmAction('Send broadcast to all members?', doBroadcast)">Send</button></div>
      <hr/>
      <label>Correct attendance</label>
      <input id="corrUser" placeholder="user id or select from users" />
      <input id="corrDate" type="date" />
      <select id="corrStatus"><option value="present">Present</option><option value="absent">Absent</option></select>
      <div style="display:flex;gap:8px;margin-top:8px"><button onclick="confirmAction('Apply correction?', doCorrectAttendance)">Apply</button></div>
    </div>
  </div>

  <!-- admin analytics modal -->
  <div id="analyticsPanel" class="card hidden">
    <strong>Analytics</strong>
    <div id="analyticsContent"></div>
  </div>

  <div class="toast" id="toast"><div class="card small" id="toastInner"></div></div>
</div>

<!-- bottom nav -->
<div class="nav-bottom">
  <div class="nav-inner">
    <button class="nav-btn active" id="navHome" onclick="navTo('home')">üè†<div>Home</div></button>
    <button class="nav-btn" id="navLog" onclick="navTo('log')">üìù<div>Log</div></button>
    <button class="nav-btn" id="navTasks" onclick="navTo('tasks')">üìã<div>Tasks</div></button>
    <button class="nav-btn" id="navMe" onclick="navTo('me')">üë§<div>Me</div></button>
  </div>
</div>

<script>
/* CONFIG: replace with your Apps Script web app URL */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1-GbxXrKoHIfXvLzHzM8Js1jdUGWnc_oohIf4oQ7jADdkcoCMHYjKZeYNbpbfS8a3/exec';

let state = { token:null, role:null, user:null };
let darkMode = false;
let realtimeInterval = null;

/* UI helpers */
function showToast(msg, ttl=2800){ const t = document.getElementById('toast'); document.getElementById('toastInner').textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', ttl); }
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function confirmAction(msg, fn){ if(confirm(msg)) fn(); }

/* Dark mode */
function toggleDark(){ darkMode = !darkMode; document.body.classList.toggle('dark', darkMode); document.getElementById('darkBtn').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô'; }

/* API helper */
async function api(data){
  if(!WEB_APP_URL || WEB_APP_URL === 'WEB_APP_URL') throw new Error('Set WEB_APP_URL in index.html');
  const body = new URLSearchParams();
  for(const k in data) if(data[k] !== undefined && data[k] !== null) body.append(k, typeof data[k] === 'object'? JSON.stringify(data[k]) : data[k]);
  const res = await fetch(WEB_APP_URL, { method:'POST', body });
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch(e){ return { error:'bad_response', raw: txt }; }
}

/* Navigation */
function setActiveNav(key){ ['navHome','navLog','navTasks','navMe'].forEach(id=>document.getElementById(id).classList.remove('active')); if(key==='home') document.getElementById('navHome').classList.add('active'); if(key==='log') document.getElementById('navLog').classList.add('active'); if(key==='tasks') document.getElementById('navTasks').classList.add('active'); if(key==='me') document.getElementById('navMe').classList.add('active'); }
function hideAll(){ ['homePanel','authPanel','memberPanel','tasksPanel','adminPanel','panelList','adminToolsPanel','analyticsPanel'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
function navTo(k){
  setActiveNav(k); hideAll();
  if(k==='home'){ document.getElementById('homePanel').classList.remove('hidden'); document.getElementById('todayLabel').textContent = new Date().toISOString().slice(0,10); document.getElementById('authBtn').textContent = state.token ? 'Logout' : 'Login'; }
  if(k==='log'){ if(!state.token){ openAuth(); return; } if(state.role === 'admin'){ openAdmin(); return; } document.getElementById('memberPanel').classList.remove('hidden'); loadToday(); }
  if(k==='tasks'){ document.getElementById('tasksPanel').classList.remove('hidden'); loadTasks(); }
  if(k==='me'){ if(!state.token){ openAuth(); return; } if(state.role === 'admin'){ openAdmin(); } else { document.getElementById('panelListInner').innerHTML = `<strong>Profile</strong><div class="small">${state.user ? (state.user.name || state.user.mobile) : ''}</div>`; document.getElementById('panelList').classList.remove('hidden'); } }
}

/* Auth UI toggles */
function openAuth(){ if(state.token){ logout(); return; } document.getElementById('authPanel').classList.toggle('hidden'); showLogin(); }
function showLogin(){ ['loginView','registerView','resetReqView','resetConfirmView'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('loginView').classList.remove('hidden'); }
function showRegister(){ ['loginView','registerView','resetReqView','resetConfirmView'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('registerView').classList.remove('hidden'); }
function showResetRequest(){ ['loginView','registerView','resetReqView','resetConfirmView'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('resetReqView').classList.remove('hidden'); }
function showResetConfirm(){ ['loginView','registerView','resetReqView','resetConfirmView'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('resetConfirmView').classList.remove('hidden'); }

/* Auth actions */
async function doRegister(){
  const mobile = document.getElementById('regMobile').value.trim(); const password = document.getElementById('regPassword').value;
  if(!mobile || !password) return document.getElementById('regMsg').textContent = 'mobile & password required';
  document.getElementById('regMsg').textContent = '';
  try{ const r = await api({action:'register', mobile, password}); if(r.ok){ showToast('Registered ‚Äî awaiting approval'); showLogin(); } else document.getElementById('regMsg').textContent = r.error || 'fail'; }catch(e){ document.getElementById('regMsg').textContent = 'network'; }
}
async function doLogin(){
  const idOrMobile = document.getElementById('loginMobile').value.trim(); const pw = document.getElementById('loginPassword').value;
  if(!idOrMobile || !pw) return document.getElementById('loginMsg').textContent = 'enter credentials';
  document.getElementById('loginMsg').textContent = '';
  try{
    if(idOrMobile === 'admin'){ const r = await api({action:'admin_login', id: idOrMobile, password: pw}); if(r && r.ok){ onAuth({token:r.token, role:'admin'}); showToast('Admin logged in'); document.getElementById('authPanel').classList.add('hidden'); return; } else return document.getElementById('loginMsg').textContent = r.error || 'invalid'; }
    const r = await api({action:'login', mobile: idOrMobile, password: pw});
    if(r && r.ok){ onAuth({token:r.token, role:r.role, user:r.user}); showToast('Logged in'); document.getElementById('authPanel').classList.add('hidden'); navTo('log'); } else document.getElementById('loginMsg').textContent = r.error || 'login failed';
  }catch(e){ document.getElementById('loginMsg').textContent = 'network'; }
}
function onAuth(info){ state.token = info.token; state.role = info.role; state.user = info.user || null; document.getElementById('authBtn').textContent = state.token ? 'Logout' : 'Login'; if(state.role === 'admin') openAdmin(); else navTo('log'); startRealtime(); }
function logout(){ state = {token:null, role:null, user:null}; document.getElementById('authBtn').textContent = 'Login'; stopRealtime(); navTo('home'); showToast('Logged out'); }

/* OTP / Reset */
async function doRequestReset(){ const mobile = document.getElementById('resetMobile').value.trim(); if(!mobile) return document.getElementById('resetReqMsg').textContent = 'enter mobile'; try{ const r = await api({action:'otp_request', mobile}); if(r && r.ok){ document.getElementById('resetConfirmMobile').value = mobile; showResetConfirm(); showToast('OTP issued (debug)'); } else document.getElementById('resetReqMsg').textContent = r.error || 'fail'; }catch(e){ document.getElementById('resetReqMsg').textContent='error'; }}
async function doConfirmReset(){ const mobile = document.getElementById('resetConfirmMobile').value.trim(); const code = document.getElementById('resetCode').value.trim(); const newPw = document.getElementById('resetNewPw').value; if(!mobile || !code || !newPw) return document.getElementById('resetConfirmMsg').textContent = 'all required'; try{ const r = await api({action:'confirm_reset', mobile, code, newPassword: newPw}); if(r && r.ok){ showToast('Password changed'); showLogin(); } else document.getElementById('resetConfirmMsg').textContent = r.error || 'fail'; }catch(e){ document.getElementById('resetConfirmMsg').textContent='error'; }}

/* Member: logs */
async function submitLog(){ const content = document.getElementById('logContent').value.trim(); if(!content) return showToast('Enter log content'); try{ const r = await api({action:'submit_log', token: state.token, content}); if(r && r.ok){ showToast('Log saved'); getMyLogs(); loadToday(); } else showToast('Save failed: '+(r.error||'')); }catch(e){ showToast('Network error'); } }
async function getMyLogs(){ try{ const r = await api({action:'get_logs', token: state.token}); if(!r.ok) return showToast('Fail'); const el = document.getElementById('myLogs'); el.innerHTML=''; r.logs.sort((a,b)=>b.date.localeCompare(a.date)); r.logs.forEach(l=>{ const div = document.createElement('div'); div.style.marginBottom='8px'; div.innerHTML = `<div style="font-weight:600">${l.date} <span style="float:right;font-size:12px">${l.time||''}</span></div><div class="small">${escapeHtml(l.content||'')}</div><div class="small-muted">Present: ${l.present} ${l.late? '¬∑ LATE':''}</div>`; el.appendChild(div); }); }catch(e){ console.error(e); } }
async function loadToday(){ if(!state.token) return; try{ const r = await api({action:'get_today_log', token: state.token}); if(r && r.ok){ document.getElementById('memberToday').textContent = r.log ? (r.log.date + ' ¬∑ ' + (r.log.present||'')) : 'No log today'; if(r.log && r.log.content) document.getElementById('logContent').value = r.log.content; } }catch(e){} }

/* TASKS */
async function loadTasks(){ try{ const el = document.getElementById('tasksList'); el.innerHTML = '<div class="skeleton" style="height:12px"></div><div class="skeleton" style="height:12px"></div>'; const r = await api({action:'get_tasks', token: state.token}); if(!r.ok) return showToast('Fail'); el.innerHTML=''; r.tasks.forEach(t=>{ const d = document.createElement('div'); d.style.marginBottom='10px'; d.innerHTML = `<div style="font-weight:600">${escapeHtml(t.title)} <span style="float:right">${t.status}</span></div><div class="small">${escapeHtml(t.description||'')}</div><div style="display:flex;gap:8px;margin-top:6px"><button onclick="openTaskComments('${t.id}')">Comments</button></div>`; el.appendChild(d); }); }catch(e){ console.error(e); } }
function openTaskComments(taskId){ const txt = prompt('Enter comment for task '+taskId); if(!txt) return; confirmAction('Post comment?', async ()=>{ const r=await api({action:'add_task_comment', token: state.token, taskId, comment: txt}); if(r && r.ok) showToast('Comment added'); else showToast('Fail'); }); }

/* ADMIN actions */
async function openAdmin(){ hideAll(); document.getElementById('adminPanel').classList.remove('hidden'); loadDashboard();}
async function loadPending(){ try{ const r = await api({action:'get_pending', token: state.token}); if(!r.ok) return showToast('Fail'); let html = '<strong>Pending</strong>'; r.pending.forEach(p=> html += `<div style="margin-top:8px">${p.mobile}<div class="small-muted">${p.createdAt}</div><div style="margin-top:6px"><button onclick="approve('${p.id}')">Approve</button> <button onclick="reject('${p.id}')" class="ghost">Reject</button></div></div>`); document.getElementById('panelListInner').innerHTML = html; document.getElementById('panelList').classList.remove('hidden'); document.getElementById('adminPanel').classList.add('hidden'); }catch(e){ showToast('Error'); } }
async function approve(id){ const r = await api({action:'approve_user', token: state.token, id}); if(r && r.ok){ showToast('Approved'); loadPending(); } else showToast('Fail'); }
async function reject(id){ const r = await api({action:'reject_user', token: state.token, id}); if(r && r.ok){ showToast('Rejected'); loadPending(); } else showToast('Fail'); }
async function loadUsers(){ try{ const r = await api({action:'get_users', token: state.token}); if(!r.ok) return showToast('Fail'); let html = '<strong>Users</strong>'; r.users.forEach(u=> html += `<div style="margin-top:8px">${escapeHtml(u.name||'(no name)')} ‚Äî ${u.mobile} <div class="small-muted">id: ${u.id} ‚Äî approved: ${u.approved} ‚Äî strikes:${u.strikes||0}</div></div>`); document.getElementById('panelListInner').innerHTML = html; document.getElementById('panelList').classList.remove('hidden'); document.getElementById('adminPanel').classList.add('hidden'); }catch(e){ showToast('Error'); } }
async function loadAttendance(){ try{ const r = await api({action:'get_attendance', token: state.token}); if(!r.ok) return showToast('Fail'); let html = '<strong>Attendance</strong>'; r.attendance.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,500).forEach(a=> html += `<div style="margin-top:8px">${a.date} ‚Äî ${a.userId} ‚Äî ${a.status}</div>`); document.getElementById('panelListInner').innerHTML = html; document.getElementById('panelList').classList.remove('hidden'); document.getElementById('adminPanel').classList.add('hidden'); }catch(e){ showToast('Error'); } }
async function loadDashboard(){ try{ const r = await api({action:'get_dashboard', token: state.token}); if(!r.ok) return showToast('Fail'); document.getElementById('adminMain').innerHTML = `<div style="display:flex;gap:10px;flex-wrap:wrap"><div style="flex:1"><strong>Total users</strong><div class="small">${r.summary.users}</div></div><div style="flex:1"><strong>Pending</strong><div class="small">${r.summary.pending}</div></div><div style="flex:1"><strong>Logs today</strong><div class="small">${r.summary.logsToday}</div></div></div>`; }catch(e){ showToast('Error'); } }

/* Admin tools */
function openAdminTools(){ hideAll(); document.getElementById('adminToolsPanel').classList.remove('hidden'); loadUsersForCorrection(); }
async function loadUsersForCorrection(){ try{ const r = await api({action:'get_users', token: state.token}); if(!r.ok) return; const sel = document.getElementById('corrUser'); sel.value = ''; sel.placeholder = 'Enter user id or paste here'; }catch(e){} }
async function doCorrectAttendance(){ const userId = document.getElementById('corrUser').value.trim(); const date = document.getElementById('corrDate').value; const status = document.getElementById('corrStatus').value; if(!userId || !date) return showToast('fill fields'); const r = await api({action:'correct_attendance', token: state.token, userId, date, status}); if(r && r.ok) showToast('Applied'); else showToast('Fail'); }

/* Export month PDF base64 download */
async function exportMonth(){ const month = document.getElementById('exportMonth').value.trim(); if(!month) return showToast('Enter month (yyyy-mm)'); const r = await api({action:'export_month_attendance', token: state.token, month}); if(!r.ok) return showToast('Fail'); if(r.pdf_base64){ const bytes = atob(r.pdf_base64); let len = bytes.length; const ab = new Uint8Array(len); for(let i=0;i<len;i++) ab[i]=bytes.charCodeAt(i); const blob = new Blob([ab], { type:'application/pdf' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = r.filename || 'attendance.pdf'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast('PDF downloaded'); } }

/* Broadcast */
async function doBroadcast(){ const msg = document.getElementById('broadcastMsg').value.trim(); if(!msg) return showToast('Enter message'); const r = await api({action:'broadcast', token: state.token, message: msg}); if(r && r.ok) showToast('Broadcast queued'); else showToast('Fail'); }

/* Strikes */
async function addStrikeToUser(userId, reason){ if(!confirm('Add strike to user '+userId+'?')) return; const r = await api({action:'add_strike', token: state.token, userId, reason}); if(r && r.ok) showToast('Strike added'); else showToast('Fail'); }

/* Analytics */
async function openAnalytics(){ hideAll(); document.getElementById('analyticsPanel').classList.remove('hidden'); const r = await api({action:'get_dashboard', token: state.token}); document.getElementById('analyticsContent').innerHTML = `<div><strong>Summary</strong><div class="small">Users: ${r.summary.users} ¬∑ Pending: ${r.summary.pending} ¬∑ Logs today: ${r.summary.logsToday}</div></div><div style="margin-top:8px"><button onclick="showStreaks()">Show streaks</button></div>`; }
async function showStreaks(){ const r = await api({action:'get_streaks', token: state.token}); if(!r.ok) return showToast('Fail'); let html = '<strong>Streaks</strong>'; r.streaks.sort((a,b)=>b.streak - a.streak).forEach(s => html += `<div style="margin-top:8px">${escapeHtml(s.name)} ‚Äî ${s.streak} days</div>`); document.getElementById('analyticsContent').innerHTML = html; }

/* Search */
let searchTimer = null;
function onSearch(){ const q = document.getElementById('searchInput').value.trim(); if(searchTimer) clearTimeout(searchTimer); searchTimer = setTimeout(()=> doSearch(q), 350); }
function onSearchClear(){ document.getElementById('searchInput').value=''; doSearch(''); }
async function doSearch(q){
  if(!q) return document.getElementById('panelListInner').innerHTML = '';
  const users = await api({action:'get_users', token: state.token});
  let html = '<strong>Search results</strong>';
  if(users && users.users){
    users.users.filter(u=> (u.mobile + ' ' + (u.name||'') ).toLowerCase().includes(q.toLowerCase())).forEach(u => html += `<div style="margin-top:8px">${escapeHtml(u.name||u.mobile)} ‚Äî ${u.mobile}<div class="small-muted">id:${u.id}</div></div>`);
  }
  document.getElementById('panelListInner').innerHTML = html;
  document.getElementById('panelList').classList.remove('hidden');
}

/* Realtime polling */
function startRealtime(){ if(realtimeInterval) return; realtimeInterval = setInterval(()=> { if(state.token) { loadToday(); } }, 15000); } 
function stopRealtime(){ if(realtimeInterval) clearInterval(realtimeInterval); realtimeInterval = null; }

/* Init */
navTo('home');
</script>
</body>
</html>
