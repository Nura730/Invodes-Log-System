<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Manager ‚Äî Invodes</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f3f6f9;
  --card:#ffffff;
  --muted:#55606a;
  --accent1:#1778ff;
  --accent2:#12c2e9;
  --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  --glass: rgba(255,255,255,0.8);
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
body{margin:0;background:var(--bg);color:var(--muted);min-height:100vh;display:flex;flex-direction:column;align-items:center;}
.container{width:100%;max-width:820px;padding:18px;}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo{width:48px;height:48px;border-radius:10px;background:var(--accent-grad);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;}
.btn{background:var(--accent-grad);color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;}
.btn.secondary{background:transparent;border:1px solid rgba(85,96,106,0.08);color:var(--muted);padding:8px 10px;}
.card{background:var(--card);padding:16px;border-radius:14px;box-shadow:0 8px 30px rgba(16,24,40,0.06);margin-bottom:18px;border:1px solid rgba(16,24,40,0.03);}
.small{font-size:13px;color:var(--muted);}
.input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(85,96,106,0.08);margin-top:8px;background:white;}
textarea{min-height:120px;resize:vertical;}
.bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;display:flex;gap:8px;background:transparent;border-radius:30px;padding:8px;z-index:999;width:min(760px,calc(100% - 40px));justify-content:space-between;}
.nav-item{flex:1;background:linear-gradient(90deg,#fff,#fff);border-radius:24px;padding:12px 14px;text-align:center;box-shadow:0 8px 30px rgba(16,24,40,0.06);cursor:pointer;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:6px;}
.nav-item.active{background:var(--accent-grad);color:white;box-shadow:0 12px 36px rgba(17,120,255,0.14);}
.hidden{display:none!important;}
.toast{position:fixed;right:18px;top:18px;background:white;padding:10px 12px;border-radius:10px;border-left:6px solid var(--accent2);box-shadow:0 8px 30px rgba(16,24,40,0.08);}
.loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(0,0,0,0.12);border-top-color:var(--accent1);animation:spin 900ms linear infinite;margin-left:8px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* Responsive */
@media(min-width:900px){ body{background:#eef3f8;} .container{margin:28px auto;} .bottom-nav{width:760px;} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">TM</div>
      <div>
        <div style="font-weight:700">Team Manager</div>
        <div class="small">Invodes</div>
      </div>
    </div>
    <div id="topRight">
      <button class="btn" id="btnLoginTop" onclick="showView('login')">Login</button>
    </div>
  </div>

  <!-- VIEWS -->
  <div id="view-login" class="card">
    <h3>Login</h3>
    <label class="small">Mobile</label>
    <input class="input" id="loginMobile" placeholder="mobile">
    <label class="small">Password</label>
    <input class="input" id="loginPassword" type="password" placeholder="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="loginBtn" onclick="doLogin()">Login</button>
      <button class="btn secondary" onclick="showView('register')">Register</button>
      <button class="btn secondary" onclick="showView('reset-request')">Forgot Password</button>
    </div>
    <div id="loginMsg" class="small" style="margin-top:8px;color:#b00020"></div>
  </div>

  <div id="view-register" class="card hidden">
    <h3>Register (Member)</h3>
    <label class="small">Mobile</label><input class="input" id="regMobile" placeholder="Mobile">
    <label class="small">Password</label><input class="input" id="regPassword" type="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="regBtn" onclick="doRegister()">Register</button>
      <button class="btn secondary" onclick="showView('login')">Back</button>
    </div>
    <div id="regMsg" class="small" style="margin-top:8px"></div>
  </div>

  <div id="view-reset-request" class="card hidden">
    <h3>Reset password</h3>
    <label class="small">Mobile</label><input class="input" id="resetMobile" placeholder="registered mobile">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="doRequestReset()">Request code (debug)</button>
      <button class="btn secondary" onclick="showView('login')">Back</button>
    </div>
    <div id="resetReqMsg" class="small" style="margin-top:8px"></div>
  </div>

  <div id="view-reset-confirm" class="card hidden">
    <h3>Set new password</h3>
    <label class="small">Mobile</label><input class="input" id="resetConfirmMobile" placeholder="Mobile">
    <label class="small">Code</label><input class="input" id="resetCode" placeholder="Enter code you received">
    <label class="small">New password</label><input class="input" id="resetNewPw" type="password">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="doConfirmReset()">Set password</button>
      <button class="btn secondary" onclick="showView('login')">Cancel</button>
    </div>
    <div id="resetConfirmMsg" class="small" style="margin-top:8px"></div>
  </div>

  <!-- Main app views -->
  <div id="view-board" class="card hidden">
    <h3>Overview</h3>
    <div class="small">Board / quick snapshot</div>
    <div style="height:140px;background:#f6f7f9;border-radius:8px;margin-top:12px;"></div>
  </div>

  <div id="view-logs" class="card hidden">
    <h3>Your Daily Log</h3>
    <div class="small" id="logStatus">Status: ‚Äî</div>
    <textarea id="logContent" class="input" placeholder="Describe today's work..."></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" onclick="submitLog()">Submit</button>
      <button class="btn secondary" onclick="getMyLogs()">My logs</button>
      <button class="btn secondary" onclick="refreshLogs()">Refresh</button>
    </div>
    <div id="myLogs" style="margin-top:12px"></div>
  </div>

  <div id="view-chat" class="card hidden">
    <h3>Team Chat</h3>
    <div id="chatList" style="height:280px;overflow:auto;padding:8px;border-radius:8px;background:#fafafa;border:1px solid rgba(0,0,0,0.02)"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="chatInput" class="input" placeholder="Message..." style="flex:1">
      <button class="btn" onclick="sendChat()">Send</button>
    </div>
  </div>

  <div id="view-attendance" class="card hidden">
    <h3>Attendance</h3>
    <div class="small">Users can see own attendance; admin sees everyone</div>
    <div style="text-align:right;margin-top:8px"><button class="btn" onclick="loadAttendance()">Refresh</button></div>
    <div id="attendanceArea" style="margin-top:12px"></div>
  </div>

  <div id="view-admin" class="card hidden">
    <h3>Admin Console</h3>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="loadPending()">Pending</button>
      <button class="btn" onclick="loadUsers()">Users</button>
      <button class="btn" onclick="loadDashboard()">Summary</button>
    </div>
    <div id="adminArea" style="margin-top:12px"></div>
  </div>

  <div id="view-profile" class="card hidden">
    <h3>Profile</h3>
    <label class="small">Full name</label>
    <input class="input" id="profileName">
    <label class="small">Picture URL</label>
    <input class="input" id="profilePic">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="saveProfile()">Save</button>
      <button class="btn secondary" onclick="changePasswordPrompt()">Change password</button>
    </div>
  </div>

</div>

<!-- toast -->
<div id="toast" class="toast hidden"></div>

<!-- bottom nav -->
<div class="bottom-nav">
  <div class="nav-item active" id="nav-board" onclick="navTo('board')">üìã <div style="font-size:12px">Board</div></div>
  <div class="nav-item" id="nav-logs" onclick="navTo('logs')">üìù <div style="font-size:12px">Logs</div></div>
  <div class="nav-item" id="nav-chat" onclick="navTo('chat')">üí¨ <div style="font-size:12px">Chat</div></div>
  <div class="nav-item" id="nav-att" onclick="navTo('attendance')">üìä <div style="font-size:12px">Attendance</div></div>
  <div class="nav-item" id="nav-admin" onclick="navTo('admin')">‚öôÔ∏è <div style="font-size:12px">Admin</div></div>
</div>

<script>
/* ---------- CONFIG ---------- */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw5lLwUGOgoFakpPqibhJOGk2ebs3ip4FeLRqJIFcHgwiyGDmds1ByY0Rf_MRadDE6j/exec'; // <-- replace with your deployed web app URL

let state = { token: null, role: null, user: null };

/* ---------- UI helpers ---------- */
function showToast(msg, ttl=3000){
  const el = document.getElementById('toast');
  el.innerText = msg; el.classList.remove('hidden');
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.classList.add('hidden'), ttl);
}

function showView(name){
  const views = ['login','register','reset-request','reset-confirm','board','logs','chat','attendance','admin','profile'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if(el) el.classList.add('hidden');
  });
  const target = document.getElementById('view-' + name);
  if(target) target.classList.remove('hidden');
  // top-right login button toggle
  const top = document.getElementById('topRight');
  if(name === 'login') top.innerHTML = `<button class="btn" id="btnLoginTop">Login</button>`;
}

function navTo(page){
  document.querySelectorAll('.nav-item').forEach(n=> n.classList.remove('active'));
  document.getElementById('nav-' + (page==='attendance'?'att':page)).classList.add('active');
  // show appropriate view
  if(page==='board') { showView('board'); }
  else if(page==='logs'){ showView('logs'); if(!state.token) return showView('login'); }
  else if(page==='chat'){ showView('chat'); if(state.token) loadChat(); else showView('login'); }
  else if(page==='attendance'){ showView('attendance'); if(state.token) loadAttendance(); else showView('login'); }
  else if(page==='admin'){ showView('admin'); if(state.role==='admin') loadDashboard(); else showToast('Admin only'); }
}

/* ---------- API helper ---------- */
async function api(data){
  if(!WEB_APP_URL || WEB_APP_URL === 'WEB_APP_URL') throw new Error('Set WEB_APP_URL at top of index.html');
  if(state.token) data.token = state.token;
  const body = new URLSearchParams();
  for(const k in data) body.append(k, typeof data[k] === 'object' ? JSON.stringify(data[k]) : data[k]);
  const res = await fetch(WEB_APP_URL, { method:'POST', body });
  const txt = await res.text();
  try{ return JSON.parse(txt); } catch(e){ return { error:'bad_response', raw: txt }; }
}

/* ---------- Auth flows ---------- */
async function doRegister(){
  const mobile = document.getElementById('regMobile').value.trim();
  const password = document.getElementById('regPassword').value;
  const msg = document.getElementById('regMsg'); msg.innerText='';
  if(!mobile||!password) return msg.innerText='Mobile & password required';
  try{
    const r = await api({action:'register', mobile, password});
    if(r.ok){ msg.style.color='green'; msg.innerText='Registered ‚Äî awaiting admin approval.'; showToast('Registered ‚Äî awaiting admin approval'); showView('login'); }
    else { msg.style.color='red'; msg.innerText = r.error || JSON.stringify(r); showToast('Register failed'); }
  }catch(e){ msg.style.color='red'; msg.innerText=e.message; }
}

async function doLogin(){
  const idOrMobile = document.getElementById('loginMobile').value.trim();
  const pw = document.getElementById('loginPassword').value;
  const msg = document.getElementById('loginMsg'); msg.innerText='';
  if(!idOrMobile || !pw) return msg.innerText='Enter credentials';
  try{
    if(idOrMobile === 'admin'){
      const r = await api({action:'admin_login', id: idOrMobile, password: pw});
      if(r && r.ok){ onAuth({token:r.token, role:'admin'}); showToast('Admin logged in'); return; }
      else return msg.innerText = r.error || 'Invalid admin';
    }
    const r = await api({action:'login', mobile: idOrMobile, password: pw});
    if(r && r.ok){ onAuth({token:r.token, role:r.role, user: r.user}); showToast('Login successful'); }
    else msg.innerText = r.error || 'Login failed';
  }catch(e){ msg.innerText = e.message || 'Network error'; }
}

function onAuth(info){
  state.token = info.token; state.role = info.role; state.user = info.user || null;
  // show top-right profile & logout
  const top = document.getElementById('topRight');
  top.innerHTML = `<span style="margin-right:8px">${state.user ? (state.user.name || state.user.mobile) : (state.role==='admin'?'Admin':'User')}</span>
    <button class="btn secondary" onclick="showProfile()">Profile</button>
    <button class="btn" onclick="logout()">Logout</button>`;
  // show default view
  navTo('board');
  // pre-load some data
  loadDashboard(); loadMyStatus(); loadChat();
}

function logout(){
  state = { token:null, role:null, user:null };
  document.getElementById('topRight').innerHTML = `<button class="btn" onclick="showView('login')">Login</button>`;
  showView('login');
  document.querySelectorAll('.nav-item').forEach(n=> n.classList.remove('active'));
  document.getElementById('nav-board').classList.add('active');
}

/* ---------- Profile ---------- */
function showProfile(){ showView('profile'); if(state.user){ document.getElementById('profileName').value = state.user.name || ''; document.getElementById('profilePic').value = state.user.picture || ''; } }
async function saveProfile(){
  const name = document.getElementById('profileName').value.trim();
  const pic = document.getElementById('profilePic').value.trim();
  if(!name && !pic) return showToast('Enter name or picture');
  const r = await api({action:'update_profile', name, picture_url: pic});
  if(r && r.ok){ showToast('Profile saved'); if(r.user) state.user = r.user; } else showToast('Save failed');
}
function changePasswordPrompt(){
  const oldPw = prompt('Enter old password');
  if(!oldPw) return;
  const newPw = prompt('Enter new password');
  if(!newPw) return;
  changePassword(oldPw, newPw);
}
async function changePassword(oldPw, newPw){
  try{
    const r = await api({action:'change_password', old: oldPw, new: newPw});
    if(r && r.ok) showToast('Password changed');
    else showToast('Change failed: ' + (r.error||''));
  }catch(e){ showToast('Network error'); }
}

/* ---------- Logs ---------- */
async function loadMyStatus(){
  // try to fetch today's log and attendance
  if(!state.token) return;
  try{
    const r = await api({action:'get_logs'});
    if(r && r.ok){
      const logs = r.logs || [];
      const today = new Date().toISOString().slice(0,10);
      const todays = logs.find(l => l.date === today);
      document.getElementById('logStatus').innerText = 'Status: ' + (todays ? (todays.present || 'present') : 'no log for today');
      document.getElementById('logContent').value = todays ? (todays.content||'') : '';
    }
  }catch(e){}
}
async function submitLog(){
  if(!state.token) return showView('login');
  const content = document.getElementById('logContent').value.trim();
  if(!content) return showToast('Enter log content');
  const btn = document.querySelector('#view-logs .btn');
  try{ btn.disabled = true;
    const r = await api({action:'submit_log', content});
    if(r && r.ok){ showToast('Log saved'); loadMyStatus(); getMyLogs(); }
    else showToast('Save failed');
  }catch(e){ showToast('Network error'); }
  finally{ btn.disabled = false; }
}
async function getMyLogs(){
  const r = await api({action:'get_logs'});
  if(!r || !r.ok) return showToast('Load logs failed');
  const el = document.getElementById('myLogs'); el.innerHTML = '';
  r.logs.sort((a,b)=> (b.date + ' ' + (b.time||'')) .localeCompare(a.date + ' ' + (a.time||'')));
  r.logs.forEach(l=>{
    const d = document.createElement('div'); d.style.marginBottom='8px';
    d.innerHTML = `<strong>${l.date}</strong> <div class="small">${l.time||''}</div><div>${escapeHtml(l.content||'')}</div>`;
    el.appendChild(d);
  });
}
function refreshLogs(){ loadMyStatus(); getMyLogs(); }

/* ---------- Attendance ---------- */
async function loadAttendance(){
  if(!state.token) return showView('login');
  const area = document.getElementById('attendanceArea'); area.innerHTML = 'Loading...';
  try{
    const r = await api({action:'get_attendance'});
    if(!r || !r.ok) { area.innerHTML = 'Failed to load attendance'; return; }
    const rows = r.attendance || [];
    if(rows.length === 0){ area.innerHTML = '<div class="small">No attendance data</div>'; return; }
    // build table
    let html = `<table style="width:100%;border-collapse:collapse"><thead><tr style="text-align:left;color:#333"><th style="padding:8px">Date</th><th style="padding:8px">Status</th><th style="padding:8px">Log ID</th>${state.role==='admin'?'<th style="padding:8px">User</th>':''}</tr></thead><tbody>`;
    rows.sort((a,b)=> b.date.localeCompare(a.date)).forEach(rw=>{
      html += `<tr><td style="padding:10px;border-top:1px solid #f0f0f0">${escapeHtml(rw.date)}</td><td style="padding:10px;border-top:1px solid #f0f0f0">${escapeHtml(rw.status)}</td><td style="padding:10px;border-top:1px solid #f0f0f0">${escapeHtml(rw.logId||'')}</td>${state.role==='admin'?`<td style="padding:10px;border-top:1px solid #f0f0f0">${escapeHtml(rw.userName||rw.userId||'')}</td>`:''}</tr>`;
    });
    html += '</tbody></table>';
    area.innerHTML = html;
  }catch(e){ area.innerHTML = 'Failed to load attendance'; }
}

/* ---------- Admin functions ---------- */
async function loadDashboard(){
  if(!state.token || state.role!=='admin') return;
  const r = await api({action:'get_dashboard'});
  if(!r || !r.ok) { showToast('Dashboard failed'); return; }
  document.getElementById('adminArea').innerHTML = `<div class="small">Users: ${r.summary.users} ‚Ä¢ Pending: ${r.summary.pending} ‚Ä¢ Logs today: ${r.summary.logsToday}</div>`;
}
async function loadPending(){
  if(!state.token || state.role!=='admin') return;
  const r = await api({action:'get_pending'});
  if(!r || !r.ok) return showToast('Load pending failed');
  const el = document.getElementById('adminArea'); el.innerHTML = '';
  r.pending.forEach(p=>{
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<strong>${p.mobile}</strong><div class="small">${p.createdAt||''}</div><div style="margin-top:8px"><button class="btn" onclick="approve('${p.id}')">Approve</button> <button class="btn secondary" onclick="reject('${p.id}')">Reject</button></div>`;
    el.appendChild(div);
  });
}
async function approve(id){ const r = await api({action:'approve_user', id}); if(r && r.ok){ showToast('Approved'); loadPending(); } else showToast('Approve failed'); }
async function reject(id){ const r = await api({action:'reject_user', id}); if(r && r.ok){ showToast('Rejected'); loadPending(); } else showToast('Reject failed'); }
async function loadUsers(){ if(!state.token || state.role!=='admin') return; const r = await api({action:'get_users'}); if(!r || !r.ok) return showToast('Load users failed'); const el=document.getElementById('adminArea'); el.innerHTML=''; r.users.forEach(u=>{ const div=document.createElement('div'); div.className='card'; div.innerHTML=`<strong>${u.name||'(no name)'} ‚Äî ${u.mobile}</strong><div class="small">id: ${u.id}</div>`; el.appendChild(div); }); }

/* ---------- Chat ---------- */
async function loadChat(){
  if(!state.token) return;
  const list = document.getElementById('chatList'); list.innerHTML = 'Loading...';
  const r = await api({action:'chat_fetch', limit:200});
  if(!r || !r.ok) return list.innerHTML = 'Failed to load chat';
  list.innerHTML = '';
  r.messages.forEach(m=>{
    const div = document.createElement('div'); div.style.marginBottom='10px';
    div.innerHTML = `<strong>${escapeHtml(m.userName||m.fromId)}</strong><div class="small">${new Date(m.createdAt||'').toLocaleString()||''}</div><div style="margin-top:6px">${escapeHtml(m.text)}</div>`;
    list.appendChild(div);
  });
  list.scrollTop = list.scrollHeight;
}
async function sendChat(){
  const txt = document.getElementById('chatInput').value.trim();
  if(!txt) return;
  const r = await api({action:'chat_send', text: txt});
  if(r && r.ok){ document.getElementById('chatInput').value=''; loadChat(); } else showToast('Send failed');
}

/* ---------- Reset flows ---------- */
async function doRequestReset(){
  const mobile = document.getElementById('resetMobile').value.trim();
  const msg = document.getElementById('resetReqMsg'); msg.innerText='';
  if(!mobile) return msg.innerText='Enter mobile';
  const r = await api({action:'request_reset', mobile});
  if(r && r.ok){ msg.style.color='green'; msg.innerText = 'Reset code: ' + (r.code||'(sent)'); document.getElementById('resetConfirmMobile').value = mobile; showView('reset-confirm'); } else { msg.style.color='red'; msg.innerText = r.error || 'Failed'; }
}
async function doConfirmReset(){
  const mobile = document.getElementById('resetConfirmMobile').value.trim();
  const code = document.getElementById('resetCode').value.trim();
  const newPw = document.getElementById('resetNewPw').value;
  const msg = document.getElementById('resetConfirmMsg'); msg.innerText='';
  if(!mobile || !code || !newPw) return msg.innerText='All fields required';
  const r = await api({action:'confirm_reset', mobile, code, newPassword: newPw});
  if(r && r.ok){ msg.style.color='green'; msg.innerText='Password changed. You can login.'; showToast('Password changed'); showView('login'); }
  else { msg.style.color='red'; msg.innerText = r.error || 'Failed'; }
}

/* ---------- Helpers ---------- */
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* ---------- Init ---------- */
showView('login');
</script>
</body>
</html>
